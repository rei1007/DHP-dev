<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運営ダッシュボード | 大学杯</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>
    <div id="loader" class="loading-mask">Processing...</div>

    <!-- 1. Login View -->
    <div id="loginView" class="login-wrapper">
        <div class="card login-card">
            <h1 class="login-title">大学杯 運営管理</h1>
            <p style="margin-bottom:20px; font-size:0.9rem;">管理用パスワードを入力してください</p>
            <form id="loginForm">
                <input type="password" id="adminPass" placeholder="Password" required>
                <button type="submit" class="btn">ログイン</button>
            </form>
            <p id="loginMsg" style="color:red; margin-top:10px; font-size:0.8rem;"></p>
        </div>
    </div>

    <!-- 2. Dashboard View -->
    <div id="dashView" class="dashboard-wrapper">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn" id="tabBtnTour" onclick="switchTab('tour')">大会管理</button>
            <button class="btn" id="tabBtnNews" onclick="switchTab('news')"
                style="background:transparent; border:1px solid #cbd5e0; color:#4a5568;">お知らせ管理</button>
        </div>

        <!-- Tournament Tab -->
        <div id="panelTour">
            <div class="dash-header">
                <div>
                    <h2>大会データ管理</h2>
                    <div style="font-size:0.8rem; color:#718096;">Firestore: tournaments</div>
                </div>
                <button class="btn btn-green" id="btnNew">＋ 新規大会作成</button>
            </div>
            <div class="tournament-list" id="tList">
                <!-- JS injected -->
            </div>
        </div>

        <!-- News Tab -->
        <div id="panelNews" style="display:none;">
            <div class="dash-header">
                <div>
                    <h2>お知らせ管理</h2>
                    <div style="font-size:0.8rem; color:#718096;">Firestore: news</div>
                </div>
                <button class="btn btn-green" id="btnNewNews">＋ お知らせ作成</button>
            </div>
            <div class="tournament-list" id="nList">
                <!-- JS injected -->
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom:20px;">大会情報の編集</h2>
            <form id="editForm">
                <input type="hidden" id="editId">

                <div class="modal-grid">
                    <!-- Left Column -->
                    <div>
                        <label>大会名</label>
                        <input type="text" id="inpName" placeholder="例: 第9回 大学杯θ" required>

                        <label>開催日時 (任意)</label>
                        <input type="datetime-local" id="inpEventDate">

                        <fieldset>
                            <legend>エントリー期間 (ステータス自動判定)</legend>
                            <label>開始日時</label>
                            <input type="datetime-local" id="inpEntryStart" onchange="window.calcStatus()">
                            <label>終了日時</label>
                            <input type="datetime-local" id="inpEntryEnd" onchange="window.calcStatus()">
                        </fieldset>

                        <label>ステータス</label>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                            <select id="inpStatus" required style="margin-bottom:0; flex:1;">
                                <option value="upcoming">開催予定 (Upcoming)</option>
                                <option value="open">エントリー受付中 (Open)</option>
                                <option value="closed">終了 (Closed)</option>
                            </select>
                            <button type="button" class="btn btn-sm" onclick="window.calcStatus(true)">再計算</button>
                        </div>

                        <label>大会規約URL</label>
                        <input type="url" id="inpRulesUrl" placeholder="https://...">

                        <label>エントリー制限タイプ</label>
                        <select id="inpEntryType">
                            <option value="circle_only">クロスサークルなし（同一サークル限定）</option>
                            <option value="cross_ok">クロスサークルあり</option>
                            <option value="invite">サークル選抜のみ</option>
                        </select>
                    </div>

                    <!-- Right Column -->
                    <div>
                        <fieldset>
                            <legend>XP制限</legend>
                            <label class="checkbox-label" style="margin-bottom:10px;">
                                <input type="checkbox" id="chkXpNone"> 制限なし
                            </label>
                            <div id="xpInputs">
                                <label>平均XP上限</label>
                                <input type="number" id="inpXpAvg" placeholder="例: 2200">
                                <label>最高XP上限</label>
                                <input type="number" id="inpXpMax" placeholder="例: 2400">
                            </div>
                        </fieldset>

                        <label>採用ルール (複数選択可)</label>
                        <div class="checkbox-group" id="ruleGroup">
                            <!-- JSで生成: ナワバリ, エリア... -->
                        </div>

                        <label>使用不可ステージ選択</label>
                        <div class="stage-grid" id="stageGroup">
                            <!-- JSで生成 -->
                        </div>
                        <!-- キャスト・配信情報 -->
                        <h4 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:5px;">キャスト・配信・許諾</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label style="font-size:0.8rem;">実況者名</label>
                                <input type="text" id="inpCasterName" placeholder="実況者名">
                            </div>
                            <div>
                                <label style="font-size:0.8rem;">実況アイコンURL</label>
                                <input type="url" id="inpCasterIcon" placeholder="https://...">
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                            <div><input type="text" id="inpCasterX" placeholder="実況 X (Twitter) ID (@...)"></div>
                            <div><input type="url" id="inpCasterYt" placeholder="実況 YouTube URL"></div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label style="font-size:0.8rem;">解説者名</label>
                                <input type="text" id="inpComName" placeholder="解説者名">
                            </div>
                            <div>
                                <label style="font-size:0.8rem;">解説アイコンURL</label>
                                <input type="url" id="inpComIcon" placeholder="https://...">
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                            <div><input type="text" id="inpComX" placeholder="解説 X (Twitter) ID (@...)"></div>
                            <div><input type="url" id="inpComYt" placeholder="解説 YouTube URL"></div>
                        </div>
                        <!-- 配信・許諾 -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label style="font-size:0.8rem;">配信担当</label>
                                <input type="text" id="inpOpName" placeholder="配信担当者名">
                            </div>
                            <div>
                                <label style="font-size:0.8rem;">任天堂許諾番号</label>
                                <input type="text" id="inpLicense" placeholder="NJ...">
                            </div>
                        </div>
                        <div style="margin-top:10px;">
                            <label style="font-size:0.8rem;">アーカイブ動画URL</label>
                            <input type="url" id="inpArchiveUrl" placeholder="https://youtube.com/...">
                        </div>

                        <!-- 優勝チーム情報 -->
                    </div>
                </div>

                <h4 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:5px;">優勝チーム情報（終了後入力）</h4>
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.9rem;">優勝画像URL (16:9)</label>
                    <input type="url" id="inpWinImage" placeholder="https://example.com/image.jpg">
                </div>
                <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:15px;">
                    <input type="text" id="inpWinTeamName" placeholder="チーム名" style="margin-bottom:0;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="text" id="inpWinUniv" placeholder="大学名" style="margin-bottom:0;">
                        <input type="text" id="inpWinCircle" placeholder="サークル名" style="margin-bottom:0;">
                    </div>
                </div>
                <label style="font-size:0.9rem;">優勝メンバー (4名)</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <input type="text" id="inpWinMem1" placeholder="メンバー1" style="margin-bottom:0;">
                    <input type="text" id="inpWinMem2" placeholder="メンバー2" style="margin-bottom:0;">
                    <input type="text" id="inpWinMem3" placeholder="メンバー3" style="margin-bottom:0;">
                    <input type="text" id="inpWinMem4" placeholder="メンバー4" style="margin-bottom:0;">
                </div>
                <input type="url" id="inpWinUrl" placeholder="結果詳細URL (Xのポスト等)">

                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                    <button type="button" class="btn btn-red" id="btnCloseModal" style="width:auto;">キャンセル</button>
                    <button type="submit" class="btn btn-green" style="width:auto;">保存する</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEWS MODAL -->
    <div id="newsModal" class="modal">
        <div class="modal-content" style="max-width:800px;">
            <h2 id="newsModalTitle" style="margin-bottom:20px;">お知らせ編集</h2>
            <form id="newsForm">
                <input type="hidden" id="newsId">

                <div style="margin-bottom:15px;">
                    <label>フォーマット</label>
                    <div style="display:flex; gap:20px; margin-top:5px;">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="radio" name="newsType" value="normal" checked onchange="toggleNewsType()">
                            通常フォーマット
                        </label>
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="radio" name="newsType" value="tournament" onchange="toggleNewsType()"> 大会フォーマット
                        </label>
                    </div>
                </div>

                <!-- Normal options -->
                <div id="newsTypeNormal">
                    <label>バッジ選択</label>
                    <select id="inpNewsBadge" style="margin-bottom:10px;">
                        <option value="info">お知らせ (Info)</option>
                        <option value="important">重要 (Important)</option>
                        <option value="recruit">運営募集 (Recruit)</option>
                        <option value="penalty">ペナルティ (Penalty)</option>
                    </select>
                </div>

                <!-- Tournament options -->
                <div id="newsTypeTour"
                    style="display:none; background:#f7fafc; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <label>対象大会</label>
                    <div style="display:flex; gap:10px;">
                        <select id="inpNewsTourId" style="flex:1;">
                            <option value="">大会を選択してください</option>
                        </select>
                        <button type="button" class="btn btn-sm" onclick="generateDraft()">下書き生成</button>
                    </div>
                    <p style="font-size:0.8rem; color:gray; margin-top:5px;">※大会を選択して「下書き生成」を押すと、本文が自動入力されます。</p>
                </div>

                <div>
                    <label>タイトル</label>
                    <input type="text" id="inpNewsTitle" placeholder="タイトルを入力" required>
                </div>

                <!-- Date -->
                <div style="margin-bottom:10px;">
                    <label>公開日</label>
                    <input type="date" id="inpNewsDate" required>
                </div>

                <div>
                    <label>本文 (Markdown)</label>
                    <div style="font-size:0.8rem; color:gray; margin-bottom:5px;">
                        #見出し, -箇条書き, **強調**, __下線__, ~~取消~~, [リンク](URL)
                    </div>
                    <textarea id="inpNewsBody" rows="10" placeholder="お知らせ本文..." required></textarea>
                </div>

                <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" class="btn btn-red" id="btnCloseNewsModal">キャンセル</button>
                    <button type="submit" class="btn">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="js/admin.js"></script>
</body>

</html>